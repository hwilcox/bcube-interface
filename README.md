# ACADIS ADE Portal / NSIDC Search Portal

An Opensearch-based single page search interface

### OPS Configuration Information

    The portal is a javascript app being served via nginx
    (http://wiki.nginx.org/Main)

    nginx configuration files are located at /etc/nginx
    nginx is running as a service, and can be stopped/started/etc using the
    system "service" command, e.g., "service nginx restart"

    The portal code is being served from /usr/shar/nginx/portal/, which is where
    the artifact deploys when the VM is provisioned.

    nginx writes logfiles by default to /var/log/nginx, all logs should be in
    this folder.

### Prerequisites:

* [RVM](https://rvm.io/rvm/install/)
* [Node](http://nodejs.org/) (includes [npm](https://www.npmjs.org/))
* [Grunt](http://gruntjs.org) - `sudo npm install -g grunt-cli`
* Install the ruby gems - `bundle install`
* Install the npm modules - `npm install`

### Project Dependencies

The search portal requires some external services to be active. The local
webserver can be configured to use public URLs from the internet or URLs under
`localhost` to access services running locally (see more under "External
services"). To have the full stack of NSIDC applications running locally, you
will need to have these projects up and running on your machine:

* [Dataset Search Services](https://bitbucket.org/nsidc/dataset-search-services/)
* [Dataset Catalog Services](https://bitbucket.org/nsidc/dataset-catalog-services/)
* [NSIDC Solr](https://bitbucket.org/nsidc/nsidc-solr/)

### Build

`grunt build:nsidc` and `grunt build:acadis` will create a `tmp/` directory
containing HTML and CSS files generated from Jade and Sass files, as well as a
minified JavaScript file created by the
[RequireJS Optimizer](http://requirejs.org/docs/optimization.html). Other files,
such as external JavaScript libs and image files, are also copied to `tmp/` so
that it contains everything needed to run the interface in a browser. This
directory can then be compressed and used for deployment.

`grunt build:nsidc-dev` and `grunt build:acadis-dev` skip the RequireJS
optimizer step, and do not create a `tmp/` directory. Instead, the generated
HTML and CSS are kept within `src/`.

The environment defaults to development, to set the environment pass an
environment argument to grunt, for example `grunt build:nsidc
--environment=production`. The CSS generated from the Sass source varies based
on the environment; for production, it will be compressed, otherwise it is more
readable and includes line numbers mapping to the original source files. The
generated HTML also uses the environment to load the appropriate configuration
from `src/conf/`.

### Running the app locally

Run `grunt build:nsidc-dev` or `grunt build:acadis-dev` to generate the
appropriate `src/index.html` file (as well as css files), then
`./run_local_webserver` and open your browser to http://localhost:8081.

To run using the code generated by the RequireJS optimizer (concatenated and
minified js, rather than the standard source), modify
`local_webserver_config.yaml` to use `tmp/` instead of `src/`.

#### External services

The external services used by the search portal are defined in
`local_webserver_config.yaml`. `search_proxies` are the default choice, and
contain endpoints for the services running on `localhost`. `integration_proxies`
and `qa_proxies` are also defined.

To run against services on integration:

```bash
./run_local_webserver 8081 integration_proxies
```

To run against services on qa:

```bash
./run_local_webserver 8081 qa_proxies
```

### Running the acceptance tests locally

Prerequisites

* Firefox
* If using the development VM under Mac OS X,
  [XQuartz](http://xquartz.macosforge.org/landing/) is required.

To run the acceptance tests on your machine from the
[development VM](https://bitbucket.org/nsidc/dev-vm-search), you will first need
to ssh with X windowing enabled. Instead of connecting with `vagrant ssh`, use
`ssh -X vagrant@127.0.0.1 -p 2222`.

By default, the target URL for the tests is the integration URL. To test against
your local code (or some other environment), pass an environment variable `URL`
to the rake command; for example, `bundle exec rake run_browser_tests
URL=localhost:8081`.

When working within a tmux session, you may not be able to open a Firefox
window. This can be fixed by modifying the environment variable `DISPLAY`. If
you connect to the VM from a new terminal window, and check the value of
`DISPLAY` in that session (`echo $DISPLAY`), you can use that value to run the
tests, i.e., `bundle exec rake run_browser_tests URL=localhost:8081
DISPLAY=localhost:10.0`.

### Running the acceptance test in Sauce Labs

To use Sauce Labs, you'll need a way to get your Sauce Labs username and API key
into the code running in `src/test/features/support/enhanced.rb`. We use the
[config injector gem](https://bitbucket.org/nsidc/config-injector-ruby-client),
which pulls the values out of a private database to keep those values secure.

`BROWSERS=config/browsers_core.yml bundle exec rake cucumber_sauce` will run
your acceptance tests in Firefox 23, on Windows 7 in Sauce Labs. You can watch
the live video on the [Sauce Labs website](https://saucelabs.com/).

The default action of `rake cucumber_sauce` runs with `browsers_full.yml`.

It's not often necessary to run every single browser/OS combination, so look in
the `config/browsers_*.yml` files. It's easy to set up new combinations, and use
the paid Sauce Labs account more sparingly.

### CSS / Sass

* The structure of our [Sass](http://sass-lang.com/) code is as follows:
    * `src/sass`
        * `_config_*.scss`
            * contains different variable definitions to separate styles across
              projects built from the common codebase
        * `*_main.scss`
            * imports the configuration and modules for that project
        * `modules/`
            * a Sass module defines the styling for a specific part of the page;
              keeping our code more modular makes it easier to identify places
              where it can be shared across projects, and makes it easier to
              find a particular selector you are interested in modifying or
              investigating
        * `utilities/`
            * our own custom Sass functions; no CSS rules are defined in here
        * `junk/`
            * old, monolithic CSS files converted to Sass syntax still needing
              cleanup (break into smaller parts, put those parts in `modules/`)
* `grunt sass:dev` generates `src/css/acadis-search.css` and
  `src/css/nsidc-search.css`, combining the project-specifc scss and the common
  files into one
* `grunt sass:$PROJECT` generates `tmp/css/$PROJECT-search.css`; this is used by
  `grunt build:$PROJECT` (see the Build section)
* `grunt sass` is configured to compress the generated CSS files and generate
  source maps, allowing tools like the Chrome Inspector to automatically show
  line numbers from the original Sass files
* `grunt scsslint` runs the [scss-lint](https://github.com/causes/scss-lint)
  tool on the Sass files. It is configured by rules in `config/scss-lint.yml`
  (with additional rules that should be cleaned up in
  `config/scsslint-todo.yml`)
* [Compass](http://compass-style.org/) is used to handle cross-browser CSS3
  features with less code in the files we write.
* Using Sass requires some gems which can be installed with `bundle install`.

### Unit tests

Run the unit tests in [PhantomJS](http://phantomjs.org/) with `grunt
jasmine`. Test code is located in `spec/`, written in
[Jasmine 1.3](http://jasmine.github.io/1.3/introduction.html) along with
[Sinon](http://sinonjs.org/).

It can helpful for debugging purposes to run the unit tests in a browser. To do
so, follow these steps:

* if you don't already have the file `_SpecRunner.html`, run `grunt jasmine` to
  generate the file
* make sure your port 8081 is open (kill the local webserver if you are
  running it)
* `grunt serve-tests`
* point your browser to [localhost:8081/_SpecRunner.html](localhost:8081/_SpecRunner.html)


### JSHint

Run with `grunt jshint`. Run automatically whenever a JavaScript file is changed
with `grunt watch:jshint`.

JSHint is configured in `.jshintrc`, a JSON file containing a list of options
and allowed global variables.

* [Official documentation for JSHint configuration options](http://www.jshint.com/docs/options/)
* [Grunt task for JSHint](http://www.github.com/gruntjs/grunt-contrib-jshint)
* [JSHint in Emacs with flycheck](https://github.com/flycheck/flycheck)
* [plugins to run JSHint in various editors and IDEs](http://www.jshint.com/install/#plugins)

### Git Hooks

Our build server attempts to build the project with every revision, and it
requires that linters and unit tests pass successfully. To protect yourself from
the embarrasment of breaking the build, git hooks can be set up to run
everything on your local box before you push.

Git hooks are configured in `Gruntfile.js` with the `grunt-githooks`
plugin. Running `grunt githooks` udpates files in your `.git/hooks/` so that the
specific grunt tasks will be run at the given git events. This means if the
githooks task configuration is ever changed, you will need to run `grunt
githooks` again to update your hook scripts (and if a hook is removed the
Gruntfile configuration, you may need to delete the old script from
`.git/hooks/`).

Currently included hooks (and the tasks they run) are:

* `pre-commit`: `scsslint` and `jshint`
* `pre-push`: `jasmine`

### Bootstrap

We are using a customized version of Bootstrap to avoid conflicts with global
NSIDC styles included via SSI. To add to the existing set of styles and scripts
go to Bootstrap's
[customize page](http://getbootstrap.com/2.3.2/customize.html).

To generate the download, first deselect all items in the "Choose components"
and "Select jQuery plugins" sections.

In "Choose components" select the following:

* Base CSS
    * Buttons
* Componets
    * Button groups and dropdowns
    * Alerts
* JS Components
    * Dropdowns

In "Select jQuery plugins" select the following:

* Dropdowns
* Buttons

Replace the `src/contrib/bootstrap/` directory with the contents of
the downloaded zip file. Be sure to update this list of components
after each new download.

### Watch

Grunt watch can be used to automatically re-run linters and tests and to
automatically regenerate HTML and CSS code running on your local webserver.

* `grunt watch:lint-test` will automatically run JSHint, scss-lint, and the
  Jasmine test suite whenever a JavaScript or Sass file is changed
* `grunt watch:build-$PROJECT` automatically runs `grunt build:$PROJECT-dev`
  whenever a Sass or Jade file is changed

### How to contact NSIDC

User Services and general information:
Support: http://support.nsidc.org
Email: nsidc@nsidc.org

Phone: +1 303.492.6199
Fax: +1 303.492.2468

Mailing address:
National Snow and Ice Data Center
CIRES, 449 UCB
University of Colorado
Boulder, CO 80309-0449 USA

### License

Every file in this repository is covered by the GNU GPL Version 3; a copy of the
license is included in the file COPYING.

### Citation Information

Andy Grauch, Brendan Billingsley, Chris Chalstrom, Danielle Harper, David Grant,
Hannah Wilcox, Ian Truslove, Jonathan Kovarik, Kevin Beam, Luis Lopez, Matt
Savoie, Miao Liu, Michael Brandt, Scott Lewis, Stuart Reed, Teri Hoyer (2013):
Arctic Data Explorer Portal / NSIDC Search Portal. The National Snow and Ice
Data Center. Software. http://ezid.cdlib.org/id/doi:10.7265/N55H7D75
